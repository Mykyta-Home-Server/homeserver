# Unified Authentication with LDAP - Complete Setup Guide

**Last Updated:** 2025-11-25

**Status:** ‚úÖ Tested and Working

---

## üìã Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Step 1: Deploy LDAP Infrastructure](#step-1-deploy-ldap-infrastructure)
- [Step 2: Initialize LDAP Directory](#step-2-initialize-ldap-directory)
- [Step 3: Configure Authelia to Use LDAP](#step-3-configure-authelia-to-use-ldap)
- [Step 4: Configure Jellyfin LDAP Plugin](#step-4-configure-jellyfin-ldap-plugin)
- [Step 5: Configure Jellyseerr](#step-5-configure-jellyseerr)
- [Step 6: Configure Unified Logout](#step-6-configure-unified-logout)
- [Testing the Complete Flow](#testing-the-complete-flow)
- [Adding New Users](#adding-new-users)
- [Troubleshooting](#troubleshooting)
- [References](#references)

---

## Overview

This guide implements **unified authentication** across all home server services using LDAP as the single source of truth for user credentials.

**What you'll achieve:**
- ‚úÖ One username/password works across all services
- ‚úÖ Centralized user management via LDAP
- ‚úÖ Authelia (SSO) authenticates against LDAP
- ‚úÖ Jellyfin authenticates against LDAP
- ‚úÖ Jellyseerr authenticates via Jellyfin (which uses LDAP)
- ‚úÖ Unified logout behavior across all services
- ‚úÖ Easy user addition - add once in LDAP, works everywhere

**Authentication Flow:**
```
LDAP (OpenLDAP)
  ‚îú‚îÄ‚Üí Authelia (SSO for protected services)
  ‚îÇ     ‚îú‚îÄ‚Üí qBittorrent (bypassed via subnet whitelist)
  ‚îÇ     ‚îú‚îÄ‚Üí Radarr, Sonarr, Prowlarr (with unified logout)
  ‚îÇ     ‚îú‚îÄ‚Üí Uptime Kuma (auth disabled)
  ‚îÇ     ‚îî‚îÄ‚Üí Grafana (with unified logout)
  ‚îÇ
  ‚îú‚îÄ‚Üí Jellyfin (direct LDAP auth via plugin)
  ‚îÇ
  ‚îî‚îÄ‚Üí Jellyseerr (authenticates via Jellyfin ‚Üí LDAP)
```

**Why This Approach:**
- **Security:** Centralized credential management reduces attack surface
- **Convenience:** Users remember one password instead of many
- **Maintainability:** Add/remove users in one place
- **Scalability:** Easy to add new services to LDAP authentication

---

## Architecture

### Components

1. **OpenLDAP** - LDAP server (osixia/openldap:1.5.0)
   - Stores user accounts and groups
   - Runs on internal network only (not exposed externally)
   - Ports: 389 (LDAP), 636 (LDAPS - not used)

2. **phpLDAPadmin** - Web-based LDAP management (osixia/phpldapadmin:0.9.0)
   - User-friendly interface for managing LDAP
   - Accessible at: https://ldap.mykyta-ryasny.dev
   - Protected by Authelia (admins only)

3. **Authelia** - SSO authentication service
   - Changed from file-based to LDAP backend
   - Protects services requiring SSO
   - Handles unified logout

4. **Jellyfin LDAP Plugin** - LDAP-Auth Plugin (v22.0.0.0)
   - Enables Jellyfin to authenticate against LDAP
   - Automatically creates users on first login
   - Syncs admin permissions from LDAP groups

5. **Jellyseerr** - Request management
   - Authenticates via Jellyfin (which uses LDAP)
   - No direct LDAP connection needed

### Network Topology

```
Docker Networks:
‚îú‚îÄ‚Üí proxy (172.18.0.0/16) - Caddy, services with external access
‚îú‚îÄ‚Üí internal (172.19.0.0/16) - Internal services (LDAP, databases)
‚îî‚îÄ‚Üí monitoring - Grafana stack

LDAP Placement:
‚îú‚îÄ‚Üí Internal network (172.19.0.0/16) - Not directly accessible externally
‚îî‚îÄ‚Üí Proxy network - phpLDAPadmin only (for web access)
```

### LDAP Directory Structure

```
dc=mykyta-ryasny,dc=dev (Base DN)
‚îú‚îÄ‚Üí ou=users (Organizational Unit for users)
‚îÇ   ‚îî‚îÄ‚Üí uid=admin (User entry)
‚îÇ       ‚îú‚îÄ‚Üí cn: Mykyta Ryasny (Common Name)
‚îÇ       ‚îú‚îÄ‚Üí mail: MykytaRyasny@gmail.com
‚îÇ       ‚îî‚îÄ‚Üí userPassword: {SSHA}hashed_password
‚îÇ
‚îî‚îÄ‚Üí ou=groups (Organizational Unit for groups)
    ‚îú‚îÄ‚Üí cn=admins (Admin group)
    ‚îÇ   ‚îî‚îÄ‚Üí member: uid=admin,ou=users,dc=mykyta-ryasny,dc=dev
    ‚îî‚îÄ‚Üí cn=family (Family group)
        ‚îî‚îÄ‚Üí member: uid=admin,ou=users,dc=mykyta-ryasny,dc=dev
```

---

## Prerequisites

Before starting, ensure you have:
- ‚úÖ Docker and Docker Compose installed
- ‚úÖ Caddy reverse proxy configured
- ‚úÖ Cloudflare Tunnel set up
- ‚úÖ Authelia working with file-based authentication
- ‚úÖ Jellyfin and Jellyseerr deployed
- ‚úÖ Access to server terminal with sudo privileges

---

## Step 1: Deploy LDAP Infrastructure

### 1.1 Add LDAP Secrets to Environment

Add LDAP credentials to `/opt/homeserver/.env`:

```bash
# OpenLDAP Configuration
LDAP_ADMIN_PASSWORD=ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=
LDAP_CONFIG_PASSWORD=5x9HDNpFAcJjsmVJdfP7+PTXsvsvHbnllKMYXf4/HZQ=
```

**Note:** These are encrypted passwords generated by the OpenLDAP container. Change them for production use.

### 1.2 Create LDAP Docker Compose Configuration

Create `/opt/homeserver/compose/ldap.yml`:

```yaml
# OpenLDAP and phpLDAPadmin Services
# LDAP provides centralized user directory for authentication

services:
  # OpenLDAP - LDAP Directory Server
  openldap:
    profiles: ["auth", "all"]
    image: osixia/openldap:1.5.0
    container_name: openldap
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: "Mykyta Home Server"
      LDAP_DOMAIN: "mykyta-ryasny.dev"
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_CONFIG_PASSWORD: ${LDAP_CONFIG_PASSWORD}
      LDAP_RFC2307BIS_SCHEMA: "true"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "true"
      LDAP_TLS_VERIFY_CLIENT: "never"
    volumes:
      - ../services/auth/ldap/database:/var/lib/ldap
      - ../services/auth/ldap/config:/etc/ldap/slapd.d
      - ../services/auth/ldap/certs:/container/service/slapd/assets/certs
    networks:
      - internal
    ports:
      - "389:389"   # LDAP port
      - "636:636"   # LDAPS port (not used but exposed)
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=mykyta-ryasny,dc=dev", "-D", "cn=admin,dc=mykyta-ryasny,dc=dev", "-w", "${LDAP_ADMIN_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5

  # phpLDAPadmin - Web-based LDAP management interface
  phpldapadmin:
    profiles: ["auth", "all"]
    image: osixia/phpldapadmin:0.9.0
    container_name: phpldapadmin
    restart: unless-stopped
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "openldap"
      PHPLDAPADMIN_HTTPS: "false"
      PHPLDAPADMIN_TRUST_PROXY_SSL: "true"
    networks:
      - internal
      - proxy
    depends_on:
      openldap:
        condition: service_healthy

networks:
  internal:
    external: true
  proxy:
    external: true
```

### 1.3 Include LDAP Services in Main Compose File

Add to `/opt/homeserver/docker-compose.yml`:

```yaml
include:
  # ... existing includes ...
  - compose/ldap.yml
```

### 1.4 Configure Caddy for phpLDAPadmin

Create `/opt/homeserver/services/proxy/caddy/sites/ldap.Caddyfile`:

```caddy
# phpLDAPadmin - LDAP user management interface
# Access: https://ldap.mykyta-ryasny.dev
https://ldap.mykyta-ryasny.dev {
    import cf_tls
    import authelia_auth  # Only admins can access

    reverse_proxy phpldapadmin:80 {
        header_up Host {http.request.host}
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {http.request.scheme}
    }

    header {
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "same-origin"
        -Server
    }
}
```

### 1.5 Configure Cloudflare Tunnel

Add to `/opt/homeserver/services/tunnel/cloudflared/config.yml`:

```yaml
ingress:
  # ... existing ingress rules ...

  # LDAP Management - phpLDAPadmin
  - hostname: ldap.mykyta-ryasny.dev
    service: https://caddy:443
    originRequest:
      noTLSVerify: true
      originServerName: ldap.mykyta-ryasny.dev
```

### 1.6 Create LDAP Directory Structure

Create directories for LDAP data:

```bash
mkdir -p /opt/homeserver/services/auth/ldap/{database,config,certs}
```

### 1.7 Add LDAP Directories to .gitignore

Add to `/opt/homeserver/.gitignore`:

```gitignore
# LDAP data directories (contain runtime data and configs)
services/auth/ldap/database/
services/auth/ldap/config/
services/auth/ldap/certs/
```

### 1.8 Deploy LDAP Services

Start OpenLDAP and phpLDAPadmin:

```bash
cd /opt/homeserver
docker compose --profile auth up -d openldap phpldapadmin
```

**Expected Output:**
```
[+] Running 2/2
 ‚úî Container openldap        Started
 ‚úî Container phpldapadmin     Started
```

### 1.9 Verify LDAP is Running

Check container status:

```bash
docker ps | grep -E 'openldap|phpldapadmin'
```

Check LDAP connectivity:

```bash
docker exec openldap ldapsearch -x -H ldap://localhost -b "dc=mykyta-ryasny,dc=dev" -D "cn=admin,dc=mykyta-ryasny,dc=dev" -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A='
```

**If successful:** You'll see LDAP directory structure (might be empty initially).

---

## Step 2: Initialize LDAP Directory

### 2.1 Create LDAP Initialization Script

Create `/opt/homeserver/services/auth/ldap/init.ldif`:

```ldif
# Create Organizational Units
dn: ou=users,dc=mykyta-ryasny,dc=dev
objectClass: organizationalUnit
ou: users

dn: ou=groups,dc=mykyta-ryasny,dc=dev
objectClass: organizationalUnit
ou: groups

# Create Groups
dn: cn=admins,ou=groups,dc=mykyta-ryasny,dc=dev
objectClass: groupOfNames
cn: admins
member: uid=admin,ou=users,dc=mykyta-ryasny,dc=dev

dn: cn=family,ou=groups,dc=mykyta-ryasny,dc=dev
objectClass: groupOfNames
cn: family
member: uid=admin,ou=users,dc=mykyta-ryasny,dc=dev

# Create Admin User
dn: uid=admin,ou=users,dc=mykyta-ryasny,dc=dev
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: admin
cn: Mykyta Ryasny
sn: Ryasny
givenName: Mykyta
mail: MykytaRyasny@gmail.com
uidNumber: 1000
gidNumber: 500
homeDirectory: /home/admin
loginShell: /bin/bash
userPassword: {SSHA}placeholder
```

### 2.2 Import LDIF into LDAP

Import the directory structure:

```bash
docker exec openldap ldapadd -x -H ldap://localhost \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=' \
  -f /tmp/init.ldif
```

**Note:** You'll need to copy the LDIF file into the container first, or create it directly in the container.

### 2.3 Set Admin User Password

Set password for the admin user:

```bash
docker exec openldap ldappasswd -x -H ldap://localhost \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=' \
  -s 'homeserver2025' \
  "uid=admin,ou=users,dc=mykyta-ryasny,dc=dev"
```

**Your LDAP admin credentials:**
- **Username:** `admin`
- **Password:** `homeserver2025`

**Change this password in production!**

### 2.4 Verify User Creation

Search for the admin user:

```bash
docker exec openldap ldapsearch -x -H ldap://localhost \
  -b "ou=users,dc=mykyta-ryasny,dc=dev" \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=' \
  "(uid=admin)"
```

**Expected Output:**
```
# admin, users, mykyta-ryasny.dev
dn: uid=admin,ou=users,dc=mykyta-ryasny,dc=dev
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: admin
cn: Mykyta Ryasny
sn: Ryasny
...
```

### 2.5 Access phpLDAPadmin Web UI

1. Visit: https://ldap.mykyta-ryasny.dev
2. Log in with Authelia first (your current admin credentials)
3. phpLDAPadmin login page appears
4. **Login DN:** `cn=admin,dc=mykyta-ryasny,dc=dev`
5. **Password:** `ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=`
6. You should see your LDAP directory structure

---

## Step 3: Configure Authelia to Use LDAP

### 3.1 Backup Current Authelia Configuration

```bash
cp /opt/homeserver/services/auth/authelia/configuration.yml \
   /opt/homeserver/services/auth/authelia/configuration.yml.backup
```

### 3.2 Update Authelia Configuration

Edit `/opt/homeserver/services/auth/authelia/configuration.yml`:

**Find this section (file-based authentication):**
```yaml
authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m

  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2id
```

**Replace with (LDAP authentication):**
```yaml
authentication_backend:
  password_reset:
    disable: true  # LDAP handles password management
  refresh_interval: 5m

  # LDAP backend - single source of truth for users
  ldap:
    implementation: custom
    address: 'ldap://openldap:389'
    timeout: 5s
    start_tls: false

    # Base DN for LDAP queries
    base_dn: 'dc=mykyta-ryasny,dc=dev'

    # Admin credentials for Authelia to query LDAP
    user: 'cn=admin,dc=mykyta-ryasny,dc=dev'
    password: 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A='

    # Where to find users
    additional_users_dn: 'ou=users'

    # User search filter - allows login by username OR email
    users_filter: '(&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=inetOrgPerson))'

    attributes:
      username: 'uid'
      mail: 'mail'
      display_name: 'cn'
      group_name: 'cn'

    # Where to find groups
    additional_groups_dn: 'ou=groups'

    # Group membership filter
    groups_filter: '(&(member={dn})(objectClass=groupOfNames))'
```

### 3.3 Restart Authelia

```bash
docker compose --profile all restart authelia
```

### 3.4 Check Authelia Logs

Verify LDAP connection:

```bash
docker logs authelia --tail=50 | grep -i ldap
```

**Expected:** No errors, should see LDAP backend initialized.

### 3.5 Test Authelia LDAP Login

1. Visit any Authelia-protected service (e.g., https://torrent.mykyta-ryasny.dev)
2. You'll be redirected to Authelia login page
3. Enter:
   - **Username:** `admin`
   - **Password:** `homeserver2025`
4. Should log in successfully! ‚úÖ

**If login fails:** Check Authelia logs for LDAP connection errors.

---

## Step 4: Configure Jellyfin LDAP Plugin

### 4.1 Install LDAP Plugin in Jellyfin

1. Visit: https://streaming.mykyta-ryasny.dev
2. Log in with Authelia (you'll see double login - we'll fix this later)
3. Log in with your **current** Jellyfin admin credentials
4. Navigate to: **Dashboard ‚Üí Plugins ‚Üí Catalog**
5. Search for: **"LDAP-Auth Plugin"** or **"LDAP Authentication Plugin"**
6. Click: **Install**
7. Wait for installation to complete
8. **Restart Jellyfin** when prompted:
   - Click **Restart** in the popup, OR
   - Go to Dashboard ‚Üí Advanced ‚Üí **Restart**

### 4.2 Configure LDAP Plugin

After Jellyfin restarts:

1. Log back in with your current Jellyfin admin credentials
2. Go to: **Dashboard ‚Üí Plugins**
3. Click on: **LDAP-Auth Plugin**
4. You'll see the configuration page

**LDAP Server Settings:**
- **LDAP Server:** `openldap`
- **LDAP Port:** `389`
- **Secure LDAP:** ‚ùå Unchecked
- **Start TLS:** ‚ùå Unchecked
- **Skip SSL/TLS Verification:** ‚úÖ Checked

**Bind Credentials (Admin User for Queries):**
- **LDAP Bind User:** `cn=admin,dc=mykyta-ryasny,dc=dev`
- **LDAP Bind User Password:** `ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=`

**Base DN and Search:**
- **LDAP Base DN for searches:** `dc=mykyta-ryasny,dc=dev`
- **LDAP Search Filter:** Leave **EMPTY**
- **LDAP Search Attributes:** `uid`

**IMPORTANT - User Attributes:**
- **LDAP Uid Attribute:** `uid`
- **LDAP Username Attribute:** `uid` (NOT `cn`!)
- **LDAP Password Attribute:** `userPassword`

**Admin Filter (Optional but Recommended):**
- **LDAP Admin Base DN:** `ou=groups,dc=mykyta-ryasny,dc=dev`
- **LDAP Admin Filter:** `(memberOf=cn=admins,ou=groups,dc=mykyta-ryasny,dc=dev)`

**User Creation:**
- **Create users in Jellyfin library:** ‚úÖ Checked
- **Enable all folders:** ‚úÖ Checked

**Click Save** at the bottom.

### 4.3 Delete Old Jellyfin Admin User (If Exists)

If you have an existing Jellyfin admin user with username `admin`, you need to delete it to avoid conflicts with LDAP user creation:

```bash
sqlite3 /opt/homeserver/services/media/jellyfin/config/data/data/jellyfin.db \
  "DELETE FROM Users WHERE Username='admin';"
```

**Why:** Jellyfin LDAP plugin needs to create a new user linked to LDAP. Existing users conflict with this process.

### 4.4 Test Jellyfin LDAP Login

1. Log out of Jellyfin (click your user icon ‚Üí Sign out)
2. On Jellyfin login page, enter:
   - **Username:** `admin`
   - **Password:** `homeserver2025`
3. Click **Sign In**
4. Should log in successfully! ‚úÖ

### 4.5 Verify User was Created and Linked to LDAP

1. Go to: **Dashboard ‚Üí Users**
2. You should see your `admin` user listed
3. It should show as an **Administrator** (because of the admin filter)

**Check LDAP plugin configuration file to verify:**

```bash
cat /opt/homeserver/services/media/jellyfin/config/data/plugins/configurations/LDAP-Auth.xml
```

Look for:
```xml
<LdapUsers>
  <LdapUser>
    <LinkedJellyfinUserId>...</LinkedJellyfinUserId>
    <LdapUid>admin</LdapUid>
    ...
  </LdapUser>
</LdapUsers>
```

This confirms the Jellyfin user is linked to the LDAP `admin` user.

### 4.6 Remove Authelia from Jellyfin (Avoid Double Login)

Since Jellyfin now has its own authentication (LDAP), we can remove Authelia protection to avoid double login.

Edit `/opt/homeserver/services/proxy/caddy/sites/media.Caddyfile`:

**Find Jellyfin section:**
```caddy
https://streaming.mykyta-ryasny.dev {
    import cf_tls
    import authelia_auth  # Remove this line
    reverse_proxy jellyfin:8096
}
```

**Change to:**
```caddy
# Jellyfin - Media streaming server
# Access: https://streaming.mykyta-ryasny.dev
# NOTE: No Authelia auth - Jellyfin has its own authentication via LDAP
https://streaming.mykyta-ryasny.dev {
    import cf_tls
    # No Authelia - users go directly to Jellyfin login (uses LDAP)
    reverse_proxy jellyfin:8096
}
```

**Reload Caddy:**
```bash
docker exec caddy caddy reload --config /etc/caddy/Caddyfile
```

**Test:** Visit https://streaming.mykyta-ryasny.dev - should go directly to Jellyfin login (no Authelia).

---

## Step 5: Configure Jellyseerr

### 5.1 Enable Jellyfin Authentication in Jellyseerr

Jellyseerr doesn't support LDAP directly, but it can authenticate via Jellyfin.

1. Visit: https://requests.mykyta-ryasny.dev
2. Log in with Authelia first (we'll remove this shortly)
3. Log in with your **current** Jellyseerr admin credentials
4. Go to: **Settings ‚Üí General ‚Üí Sign-In**
5. Enable: **"Enable Jellyfin Sign-In"** or **"Use Jellyfin for authentication"**
6. Configure:
   - **Jellyfin URL:** `http://jellyfin:8096`
   - Make sure Jellyfin authentication is enabled
7. **Save settings**

### 5.2 Remove Authelia from Jellyseerr

Edit `/opt/homeserver/services/proxy/caddy/sites/media.Caddyfile`:

**Find Jellyseerr section:**
```caddy
https://requests.mykyta-ryasny.dev {
    import cf_tls
    import authelia_auth  # Remove this line
    reverse_proxy jellyseerr:5055
}
```

**Change to:**
```caddy
# Jellyseerr - Request management interface
# Access: https://requests.mykyta-ryasny.dev
# NOTE: No Authelia auth - Jellyseerr uses Jellyfin authentication (which uses LDAP)
https://requests.mykyta-ryasny.dev {
    import cf_tls
    # No Authelia - users authenticate via Jellyfin (uses LDAP)
    reverse_proxy jellyseerr:5055
}
```

**Reload Caddy:**
```bash
docker exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### 5.3 Test Jellyseerr Login

1. Visit: https://requests.mykyta-ryasny.dev
2. Click: **"Sign in with Jellyfin"** (or similar button)
3. Enter your LDAP credentials:
   - **Username:** `admin`
   - **Password:** `homeserver2025`
4. Should authenticate via Jellyfin ‚Üí LDAP! ‚úÖ

---

## Step 6: Configure Unified Logout

### 6.1 The Problem

When users click logout in services like Radarr, Sonarr, or Prowlarr, the service logs out locally but doesn't clear the Authelia session. Users are immediately logged back in when they revisit the page.

**Desired Behavior:** Logout button should:
1. Clear the Authelia session
2. Redirect to Authelia logout page
3. After re-login, return to the original service

### 6.2 Solution: Caddy Logout Interceptors

We'll use Caddy to intercept `/logout` paths and redirect to Authelia logout with a return URL parameter.

Edit `/opt/homeserver/services/proxy/caddy/sites/media.Caddyfile`:

**For Radarr:**
```caddy
# Radarr - Movie automation
# Access: https://movies.mykyta-ryasny.dev
https://movies.mykyta-ryasny.dev {
    import cf_tls
    import authelia_auth

    # Intercept logout and redirect to Authelia logout with return URL
    @logout path /logout
    redir @logout https://auth.mykyta-ryasny.dev/logout?rd=https://movies.mykyta-ryasny.dev 302

    reverse_proxy radarr:7878
}
```

**For Sonarr:**
```caddy
# Sonarr - TV show automation
# Access: https://tv.mykyta-ryasny.dev
https://tv.mykyta-ryasny.dev {
    import cf_tls
    import authelia_auth

    # Intercept logout and redirect to Authelia logout with return URL
    @logout path /logout
    redir @logout https://auth.mykyta-ryasny.dev/logout?rd=https://tv.mykyta-ryasny.dev 302

    reverse_proxy sonarr:8989
}
```

**For Prowlarr:**
```caddy
# Prowlarr - Indexer manager
# Access: https://indexers.mykyta-ryasny.dev
https://indexers.mykyta-ryasny.dev {
    import cf_tls
    import authelia_auth

    # Intercept logout and redirect to Authelia logout with return URL
    @logout path /logout
    redir @logout https://auth.mykyta-ryasny.dev/logout?rd=https://indexers.mykyta-ryasny.dev 302

    reverse_proxy prowlarr:9696
}
```

### 6.3 Apply the Same Pattern to Other Services

**For Grafana** (if not already configured):

Edit `/opt/homeserver/services/monitoring/grafana/config/grafana.ini`:

```ini
[auth.proxy]
signout_redirect_url = https://auth.mykyta-ryasny.dev/logout
```

Restart Grafana:
```bash
docker compose --profile all restart grafana
```

### 6.4 Reload Caddy Configuration

```bash
docker exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### 6.5 Test Unified Logout

**Test with Radarr:**
1. Visit: https://movies.mykyta-ryasny.dev
2. Log in with Authelia (username: `admin`, password: `homeserver2025`)
3. Once in Radarr, click the **logout icon** (top right)
4. You should be redirected to Authelia logout page
5. Authelia session is cleared
6. Click login again
7. After Authelia login, you should be redirected back to https://movies.mykyta-ryasny.dev ‚úÖ

**Repeat for Sonarr, Prowlarr, and Grafana** - should work the same way.

---

## Testing the Complete Flow

### Test 1: Authelia LDAP Login
```
1. Visit: https://torrent.mykyta-ryasny.dev
2. Redirected to Authelia login page
3. Enter: admin / homeserver2025
4. Should log in and redirect to qBittorrent ‚úÖ
5. qBittorrent should be accessible without its own login (subnet bypass) ‚úÖ
```

### Test 2: Jellyfin Direct LDAP Login
```
1. Visit: https://streaming.mykyta-ryasny.dev
2. No Authelia redirect - goes directly to Jellyfin login ‚úÖ
3. Enter: admin / homeserver2025
4. Should log in to Jellyfin successfully ‚úÖ
```

### Test 3: Jellyseerr via Jellyfin Auth
```
1. Visit: https://requests.mykyta-ryasny.dev
2. No Authelia redirect - goes directly to Jellyseerr ‚úÖ
3. Click: "Sign in with Jellyfin"
4. Enter: admin / homeserver2025
5. Should log in to Jellyseerr via Jellyfin ‚Üí LDAP ‚úÖ
```

### Test 4: Unified Logout (Radarr Example)
```
1. Visit: https://movies.mykyta-ryasny.dev
2. Log in with Authelia (admin / homeserver2025)
3. Access Radarr interface
4. Click logout button (top right)
5. Redirected to Authelia logout page ‚úÖ
6. Authelia session cleared ‚úÖ
7. Click login, enter credentials again
8. After login, redirected back to https://movies.mykyta-ryasny.dev ‚úÖ
```

### Test 5: Add New User and Verify Access
```
1. Visit: https://ldap.mykyta-ryasny.dev
2. Log in with Authelia (admin / homeserver2025)
3. Log in to phpLDAPadmin (cn=admin,dc=mykyta-ryasny,dc=dev / LDAP_ADMIN_PASSWORD)
4. Navigate to: ou=users,dc=mykyta-ryasny,dc=dev
5. Click: "Create new entry"
6. Select: "Generic: User Account"
7. Fill in user details:
   - uid: testuser
   - cn: Test User
   - sn: User
   - mail: testuser@example.com
   - password: testpassword123
8. Create the user
9. Add user to family group (optional)
10. Try logging in to Authelia with: testuser / testpassword123 ‚úÖ
11. Try logging in to Jellyfin with: testuser / testpassword123 ‚úÖ
```

---

## Adding New Users

### Method 1: Via phpLDAPadmin Web UI (Easiest)

1. Visit: https://ldap.mykyta-ryasny.dev
2. Log in with Authelia ‚Üí phpLDAPadmin
3. Navigate to: `ou=users,dc=mykyta-ryasny,dc=dev`
4. Click: **"Create new entry"**
5. Select: **"Generic: User Account"**
6. Fill in user details:
   - **uid:** username (e.g., `john`)
   - **cn:** Full Name (e.g., `John Doe`)
   - **sn:** Last Name (e.g., `Doe`)
   - **givenName:** First Name (e.g., `John`)
   - **mail:** Email (e.g., `john@example.com`)
   - **uidNumber:** Unique number (e.g., `1001`)
   - **gidNumber:** Group ID (e.g., `501` for family)
   - **homeDirectory:** `/home/john`
   - **loginShell:** `/bin/bash`
   - **userPassword:** User's password
7. Click: **"Create Object"**
8. User can now log in to all services! ‚úÖ

**To make user an admin:**
1. Navigate to: `cn=admins,ou=groups,dc=mykyta-ryasny,dc=dev`
2. Click: **"Add attribute"**
3. Select: **member**
4. Enter: `uid=john,ou=users,dc=mykyta-ryasny,dc=dev`
5. Save

### Method 2: Via Command Line

Create user LDIF file:

```bash
cat > /tmp/newuser.ldif << 'EOF'
dn: uid=john,ou=users,dc=mykyta-ryasny,dc=dev
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: john
cn: John Doe
sn: Doe
givenName: John
mail: john@example.com
uidNumber: 1001
gidNumber: 501
homeDirectory: /home/john
loginShell: /bin/bash
userPassword: placeholder
EOF
```

Add user to LDAP:

```bash
docker exec openldap ldapadd -x -H ldap://localhost \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=' \
  -f /tmp/newuser.ldif
```

Set password:

```bash
docker exec openldap ldappasswd -x -H ldap://localhost \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=' \
  -s 'johns_password' \
  "uid=john,ou=users,dc=mykyta-ryasny,dc=dev"
```

Add to family group:

```bash
cat > /tmp/addmember.ldif << 'EOF'
dn: cn=family,ou=groups,dc=mykyta-ryasny,dc=dev
changetype: modify
add: member
member: uid=john,ou=users,dc=mykyta-ryasny,dc=dev
EOF

docker exec openldap ldapmodify -x -H ldap://localhost \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=' \
  -f /tmp/addmember.ldif
```

New user can immediately log in with:
- Username: `john`
- Password: `johns_password`

---

## Troubleshooting

### Problem: Authelia Won't Connect to LDAP

**Symptoms:**
- Authelia logs show LDAP connection errors
- Login page shows "Invalid credentials" immediately

**Fix:**
```bash
# Check Authelia logs
docker logs authelia --tail=100 | grep -i ldap

# Test LDAP connectivity from Authelia container
docker exec authelia ping openldap

# Verify LDAP is running
docker ps | grep openldap

# Test LDAP search manually
docker exec openldap ldapsearch -x -H ldap://localhost \
  -b "dc=mykyta-ryasny,dc=dev" \
  -D "cn=admin,dc=mykyta-ryasny,dc=dev" \
  -w 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A='
```

### Problem: Jellyfin LDAP Plugin Shows "Invalid username or password"

**Symptoms:**
- Jellyfin LDAP plugin installed but login fails
- Jellyfin logs show "Found no users matching [username] in LDAP search"

**Common Causes:**
1. **Wrong LdapUsernameAttribute:**
   - Make sure it's set to `uid`, NOT `cn`
   - cn = Common Name (full name like "Mykyta Ryasny")
   - uid = Username (like "admin")

2. **LdapSearchAttributes causing malformed query:**
   - Set to just `uid`, not a comma-separated list
   - Empty value also causes errors

3. **Old Jellyfin user conflicts with LDAP user:**
   - Delete existing Jellyfin user with same username
   - Plugin needs to create new user linked to LDAP

**Fix Process:**
```bash
# 1. Check Jellyfin LDAP plugin config
cat /opt/homeserver/services/media/jellyfin/config/data/plugins/configurations/LDAP-Auth.xml

# Verify these settings:
# <LdapUsernameAttribute>uid</LdapUsernameAttribute>  (NOT cn!)
# <LdapSearchAttributes>uid</LdapSearchAttributes>    (just uid)
# <LdapSearchFilter></LdapSearchFilter>               (empty)
# <CreateUsersFromLdap>true</CreateUsersFromLdap>
# <EnableAllFolders>true</EnableAllFolders>

# 2. Delete old Jellyfin admin user if exists
sqlite3 /opt/homeserver/services/media/jellyfin/config/data/data/jellyfin.db \
  "DELETE FROM Users WHERE Username='admin';"

# 3. Restart Jellyfin
docker compose --profile all restart jellyfin

# 4. Try logging in again with LDAP credentials
# Username: admin
# Password: homeserver2025
```

### Problem: Jellyseerr Won't Authenticate

**Symptoms:**
- Jellyseerr shows "Invalid credentials" when using Jellyfin auth
- "Sign in with Jellyfin" button doesn't work

**Fix:**
```bash
# 1. Make sure Jellyfin LDAP is working first
# Jellyseerr ‚Üí Jellyfin ‚Üí LDAP (chain dependency)

# 2. Check Jellyseerr logs
docker logs jellyseerr --tail=100

# 3. Verify Jellyfin auth is enabled in Jellyseerr settings
# Settings ‚Üí General ‚Üí Sign-In ‚Üí Enable Jellyfin Sign-In

# 4. Verify Jellyfin URL is correct
# Should be: http://jellyfin:8096 (internal Docker network)

# 5. Test Jellyfin login directly first
# If Jellyfin LDAP works, Jellyseerr should work too
```

### Problem: Logout Doesn't Clear Authelia Session

**Symptoms:**
- Click logout in service (Radarr, Sonarr, etc.)
- Service logs out but immediately logs back in
- Authelia session still active

**Fix:**
Make sure Caddy logout interceptors are configured:

```bash
# Check Caddy config
cat /opt/homeserver/services/proxy/caddy/sites/media.Caddyfile | grep -A2 "logout"

# Should see:
# @logout path /logout
# redir @logout https://auth.mykyta-ryasny.dev/logout?rd=https://[service-url] 302

# Reload Caddy if needed
docker exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### Problem: Logout Works But Returns to Wrong Page

**Symptoms:**
- Logout clears session successfully
- After re-login, redirected to home page instead of original service

**Cause:** Missing `rd=` parameter in logout URL

**Fix:**
Add return URL to logout redirect:

```caddy
# WRONG (no return URL):
redir @logout https://auth.mykyta-ryasny.dev/logout 302

# RIGHT (with return URL):
redir @logout https://auth.mykyta-ryasny.dev/logout?rd=https://movies.mykyta-ryasny.dev 302
```

### Problem: Git Can't Read LDAP Config Files

**Symptoms:**
```
warning: could not open directory 'services/auth/ldap/config/'
```

**Cause:** LDAP config files have restrictive permissions (OpenLDAP security)

**Fix:**
Add LDAP directories to `.gitignore`:

```bash
# Add to /opt/homeserver/.gitignore
services/auth/ldap/database/
services/auth/ldap/config/
services/auth/ldap/certs/
```

These directories contain runtime data and shouldn't be in version control anyway.

---

## References

**LDAP Documentation:**
- [OpenLDAP Documentation](https://www.openldap.org/doc/)
- [osixia/docker-openldap GitHub](https://github.com/osixia/docker-openldap)
- [phpLDAPadmin Documentation](http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page)

**Authelia LDAP:**
- [Authelia LDAP Backend Configuration](https://www.authelia.com/configuration/first-factor/ldap/)
- [Authelia Authentication Backend](https://www.authelia.com/configuration/first-factor/introduction/)

**Jellyfin LDAP:**
- [Jellyfin LDAP Plugin GitHub](https://github.com/jellyfin/jellyfin-plugin-ldapauth)
- [Jellyfin Plugin Documentation](https://jellyfin.org/docs/general/server/plugins/)

**LDAP Concepts:**
- [LDAP Basics](https://ldap.com/learn/ldap-basics/)
- [Understanding LDAP DN (Distinguished Names)](https://ldap.com/ldap-dns-and-rdns/)
- [LDIF File Format](https://ldap.com/ldif-the-ldap-data-interchange-format/)

**Caddy Reverse Proxy:**
- [Caddy Matchers](https://caddyserver.com/docs/caddyfile/matchers)
- [Caddy Redirects](https://caddyserver.com/docs/caddyfile/directives/redir)

---

## Next Steps

Now that unified authentication is working:

1. ‚úÖ **Test with multiple services** - Verify all login flows work correctly
2. ‚úÖ **Add more users** - Create test users to verify the setup
3. üìã **Document user management procedures** - Create guide for adding/removing users
4. üìã **Implement password reset flow** - Configure LDAP password reset (optional)
5. üìã **Set up LDAP backups** - Backup LDAP database regularly
6. üîÆ **Build user management UI** - Add LDAP user management to custom portal (future)
7. üîÆ **Implement MCP server** - Natural language automation with LDAP integration (future)

---

## Summary

**What you've accomplished:**

- ‚úÖ **Deployed LDAP infrastructure** - OpenLDAP and phpLDAPadmin running
- ‚úÖ **Initialized LDAP directory** - Users, groups, and organizational units created
- ‚úÖ **Configured Authelia LDAP backend** - SSO authenticates against LDAP
- ‚úÖ **Configured Jellyfin LDAP plugin** - Jellyfin authenticates against LDAP
- ‚úÖ **Configured Jellyseerr Jellyfin auth** - Jellyseerr uses Jellyfin (which uses LDAP)
- ‚úÖ **Implemented unified logout** - Logout clears Authelia session across services
- ‚úÖ **Removed double login** - Jellyfin and Jellyseerr no longer behind Authelia

**Result:** One username/password (`admin` / `homeserver2025`) works across all services!

**Management:** Add users once in LDAP ‚Üí they work everywhere automatically.

**Current Credentials:**
- **LDAP Admin DN:** `cn=admin,dc=mykyta-ryasny,dc=dev`
- **LDAP Admin Password:** `ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A=`
- **User Login:** `admin` / `homeserver2025`

---

**Related Files:**
- [Authelia Configuration](../services/auth/authelia/configuration.yml)
- [LDAP Docker Compose](../compose/ldap.yml)
- [Caddy Media Sites Config](../services/proxy/caddy/sites/media.Caddyfile)
- [Jellyfin LDAP Plugin Config](../services/media/jellyfin/config/data/plugins/configurations/LDAP-Auth.xml)
- [Session Notes](../sessions/SESSION_LOG.md)
