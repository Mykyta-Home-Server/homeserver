name: Deploy to Home Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Trigger deployment on home server
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          DEPLOYMENT_TOKEN: ${{ secrets.DEPLOYMENT_TOKEN }}
          HOMESERVER_KEY: ${{ secrets.HOMESERVER_KEY }}
        run: |
          # Extract service name from repository (e.g., mykytaryasny/homeserver-portal -> portal)
          SERVICE_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2 | sed 's/homeserver-//')

          # Get the latest tag
          IMAGE_TAG="${{ fromJSON(steps.meta.outputs.json).tags[0] }}"

          # Create payload (compact JSON, no extra whitespace)
          PAYLOAD=$(jq -n \
            --arg service "${SERVICE_NAME}" \
            --arg image "${IMAGE_TAG}" \
            --arg repository "${{ github.repository }}" \
            --arg commit "${{ github.sha }}" \
            --arg message "${{ github.event.head_commit.message }}" \
            '{service: $service, image: $image, repository: $repository, commit: $commit, message: $message}')

          # Debug: Show what we're sending
          echo "=========================================="
          echo "üîç Deployment Request Debug Info"
          echo "=========================================="
          echo "Service: ${SERVICE_NAME}"
          echo "Image: ${IMAGE_TAG}"
          echo "Payload: $PAYLOAD"
          echo ""
          echo "Headers being sent:"
          echo "  X-Homeserver-Key: ${HOMESERVER_KEY}"
          echo "  X-Deployment-Token: ${DEPLOYMENT_TOKEN:0:20}..."
          echo "  X-Hub-Signature-256: sha256=<calculated>"
          echo "=========================================="

          # Calculate HMAC signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

          # Send deployment request with all authentication headers (with verbose output)
          echo "Sending request to https://deploy.mykyta-ryasny.dev/deploy"
          RESPONSE=$(curl -v -w "\n%{http_code}" -X POST https://deploy.mykyta-ryasny.dev/deploy \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -H "X-Deployment-Token: $DEPLOYMENT_TOKEN" \
            -H "X-Homeserver-Key: $HOMESERVER_KEY" \
            -d "$PAYLOAD" 2>&1 | tee /tmp/curl_output.txt | tail -n 50)

          # Extract HTTP status code and body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"

          # Check if deployment was successful
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Deployment failed with status $HTTP_CODE"
            exit 1
          fi

          # Check if response indicates success
          if echo "$BODY" | jq -e '.success == true' > /dev/null; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment reported failure"
            exit 1
          fi

# ============================================================================
# GitHub Secrets Required
# ============================================================================
#
# Add these secrets to your repository:
# Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
#
# 1. WEBHOOK_SECRET
#    Value: REDACTED_WEBHOOK_SECRET_64_CHARS_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#    Purpose: HMAC signature verification
#
# 2. DEPLOYMENT_TOKEN
#    Value: REDACTED_DEPLOYMENT_TOKEN_XXXXXXXXXXXXXXX
#    Purpose: Additional authentication layer
#
# 3. HOMESERVER_KEY
#    Value: REDACTED_HOMESERVER_KEY_64_CHARS_XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#    Purpose: Cloudflare WAF bypass authentication
#
# ============================================================================
# Security Layers
# ============================================================================
#
# Your deployment API now has MULTIPLE security layers:
#
# 1. ‚úÖ Cloudflare Tunnel - No exposed ports, traffic through Cloudflare
# 2. ‚úÖ HTTPS/TLS - Encrypted communication via Caddy
# 3. ‚úÖ HMAC Signature - Cryptographic verification of request authenticity
# 4. ‚úÖ Deployment Token - Static token for additional verification
# 5. ‚úÖ Service Whitelist - Only allowed services can be deployed
# 6. ‚úÖ Internal Network - Deploy API not directly accessible
#
# Without ALL of these, deployment requests will be rejected:
# - Missing deployment token ‚Üí 403 Forbidden
# - Invalid HMAC signature ‚Üí 403 Invalid signature
# - Unlisted service ‚Üí 400 Bad Request
#
# ============================================================================
