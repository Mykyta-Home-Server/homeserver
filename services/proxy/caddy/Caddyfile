# ============================================================================
# Caddyfile - Master Configuration
# ============================================================================
# This is the main Caddy configuration file that imports all service configs.
# Individual service configurations are stored in the sites/ directory.
#
# To add a new service:
# 1. Create a new .caddy file in sites/ directory
# 2. Use the (cf_tls) snippet for Cloudflare Origin Certificates
# 3. Caddy will automatically load it on restart/reload
# ============================================================================

# Global Options
{
    # Disable automatic HTTPS - we manually configure TLS with Cloudflare certs
    auto_https off
}

# ============================================================================
# Reusable Snippets
# ============================================================================

# Cloudflare Origin Certificate snippet
# Use this in all HTTPS site blocks: import cf_tls
(cf_tls) {
    tls /etc/caddy/certs/origin.pem /etc/caddy/certs/origin.key
}

# ============================================================================
# Authentik Forward Authentication Snippet
# ============================================================================
# Use this to protect services with SSO: import authentik_auth
# Requires: Proxy Provider configured in Authentik with Forward Auth mode
(authentik_auth) {
    # Forward authentication to Authentik outpost
    forward_auth authentik-server:9000 {
        uri /outpost.goauthentik.io/auth/caddy

        # Copy Authentik headers - capitalization is important!
        copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt X-Authentik-Meta-Jwks X-Authentik-Meta-Outpost X-Authentik-Meta-Provider X-Authentik-Meta-App X-Authentik-Meta-Version

        # Trust private ranges (Docker network)
        trusted_proxies private_ranges
    }
}

# ============================================================================
# Import All Service Configurations
# ============================================================================

# Import all .Caddyfile files from the sites directory
import sites/*.Caddyfile
