# ============================================================================
# Authelia Configuration
# ============================================================================
# Official docs: https://www.authelia.com/configuration/prologue/introduction/
#
# Key Concepts:
#   - Authentication: Verifying who you are (login)
#   - Authorization: Verifying what you can access (permissions)
#   - Session: Maintaining login state across requests
#   - Forward Auth: Caddy asks Authelia "is this user allowed?" before serving content
# ============================================================================

# ============================================================================
# Server Configuration
# ============================================================================
server:
  # Host and port Authelia listens on (inside container)
  address: 'tcp://:9091'

  # Disable telemetry
  disable_healthcheck: false

# ============================================================================
# Logging
# ============================================================================
log:
  level: info  # Options: trace, debug, info, warn, error
  format: text  # Options: text, json

# ============================================================================
# Theme Configuration
# ============================================================================
theme: auto  # Options: light, dark, auto (follows system preference)

# ============================================================================
# JSON Web Tokens (JWT) Configuration
# ============================================================================
# JWTs are used for identity verification tokens
# NOTE: This value is loaded from AUTHELIA_JWT_SECRET environment variable
# No need to specify here - Authelia reads it automatically from env

# ============================================================================
# Default Redirection URL
# ============================================================================
# Where to redirect after successful login (your custom dashboard)
default_redirection_url: https://home.mykyta-ryasny.dev

# ============================================================================
# TOTP (Time-based One-Time Password) Configuration
# ============================================================================
# Optional: Two-factor authentication
totp:
  disable: false
  issuer: mykyta-ryasny.dev
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1

# ============================================================================
# WebAuthn (Hardware Keys) Configuration
# ============================================================================
# Optional: Hardware security keys (YubiKey, etc.)
# Commented out for now, can enable later
# webauthn:
#   disable: false
#   display_name: Authelia
#   attestation_conveyance_preference: indirect
#   user_verification: preferred
#   timeout: 60s

# ============================================================================
# Duo Push 2FA Configuration
# ============================================================================
# Optional: Duo mobile push notifications
# Commented out - requires Duo account
# duo_api:
#   disable: false
#   hostname: api-XXXXXXXX.duosecurity.com
#   integration_key: ABCDEFGHIJKLMNOPQRST
#   secret_key: your-duo-secret-key

# ============================================================================
# Authentication Backend
# ============================================================================
authentication_backend:
  # Disable password reset (can enable later with SMTP)
  password_reset:
    disable: true

  # Refresh interval for user data
  refresh_interval: 5m

  # Password hashing configuration
  # Note: password_policy moved to top level in newer Authelia versions

  # ============================================================================
  # LDAP Authentication Backend
  # ============================================================================
  # Centralized user directory - single source of truth for all services
  ldap:
    # LDAP server implementation
    implementation: custom

    # LDAP server address (internal Docker network)
    address: 'ldap://openldap:389'

    # Connection timeout
    timeout: 5s

    # Don't use StartTLS (we're on internal network)
    start_tls: false

    # Base DN for all LDAP queries
    base_dn: 'dc=mykyta-ryasny,dc=dev'

    # Admin credentials for Authelia to query LDAP
    user: 'cn=admin,dc=mykyta-ryasny,dc=dev'
    password: 'ZRR+BWr7vErpTSzdaiZgOZEMqNmLJCDQSfi3ptVh/3A='

    # Where to find users (relative to base_dn)
    additional_users_dn: 'ou=users'

    # User search filter - allows login by username OR email
    users_filter: '(&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=inetOrgPerson))'

    # LDAP attributes for user info (modern format)
    attributes:
      username: 'uid'
      mail: 'mail'
      display_name: 'cn'
      group_name: 'cn'

    # Where to find groups (relative to base_dn)
    additional_groups_dn: 'ou=groups'

    # Group membership filter
    groups_filter: '(&(member={dn})(objectClass=groupOfNames))'

# ============================================================================
# Password Policy
# ============================================================================
# Enforce strong passwords for new users
password_policy:
  standard:
    enabled: false
  zxcvbn:
    enabled: true
    min_score: 3  # 0-4, where 4 is most secure

# ============================================================================
# Access Control Rules
# ============================================================================
# This is where you define who can access what
access_control:
  # Default policy if no rules match
  default_policy: deny

  # Define rules (order matters - first match wins)
  rules:
    # ========================================================================
    # Public Resources (no authentication required)
    # ========================================================================
    # Currently none - all services require login

    # ========================================================================
    # Bypass Authelia itself (prevent redirect loop)
    # ========================================================================
    - domain: auth.mykyta-ryasny.dev
      policy: bypass

    # ========================================================================
    # Admin-only Services
    # ========================================================================
    # Services that only administrators should access
    - domain:
        - "monitor.mykyta-ryasny.dev"      # Grafana monitoring
        - "uptime.mykyta-ryasny.dev"       # Uptime Kuma
        - "indexers.mykyta-ryasny.dev"     # Prowlarr
        - "torrent.mykyta-ryasny.dev"      # qBittorrent
      policy: one_factor  # Just password for now (can enable 2FA later)
      subject:
        - ["group:admins"]

    # ========================================================================
    # Media Management - Admin Only (Radarr, Sonarr)
    # ========================================================================
    - domain:
        - "movies.mykyta-ryasny.dev"       # Radarr
        - "tv.mykyta-ryasny.dev"           # Sonarr
      policy: one_factor
      subject:
        - ["group:admins"]

    # ========================================================================
    # Family Access - Request, Streaming, Home Portal
    # ========================================================================
    # Jellyseerr - Request content (Admin + Family)
    - domain:
        - "requests.mykyta-ryasny.dev"    # Jellyseerr
        - "streaming.mykyta-ryasny.dev"   # Jellyfin
        - "home.mykyta-ryasny.dev"         # Your custom Angular dashboard
      policy: one_factor
      subject:
        - ["group:admins"]
        - ["group:family"]

    # ========================================================================
    # Default: Require authentication for everything else
    # ========================================================================
    # Commented out - specific rules above cover all services
    # Uncomment and customize if you add new services
    # - domain:
    #     - "*.mykyta-ryasny.dev"
    #   policy: one_factor
    #   subject:
    #     - ["group:admins"]

# ============================================================================
# Session Configuration
# ============================================================================
session:
  # Session name (cookie name)
  name: authelia_session

  # Session domain (must match your domain)
  domain: mykyta-ryasny.dev  # Works for all *.mykyta-ryasny.dev subdomains

  # Session secret (loaded from AUTHELIA_SESSION_SECRET environment variable)
  # Authelia reads this automatically from env

  # Session expiration
  expiration: 24h     # Inactive sessions expire after 24 hours (increased for media streaming)
  inactivity: 5m      # Refresh activity every 5 minutes
  remember_me: 1M     # "Remember me" keeps session for 1 month

  # Session storage backend (Redis for performance)
  redis:
    host: redis-auth
    port: 6379
    # No password (Redis is on internal network only)
    database_index: 0
    maximum_active_connections: 10
    minimum_idle_connections: 0

# ============================================================================
# Regulation Configuration
# ============================================================================
# Prevent brute-force attacks
regulation:
  # Maximum failed login attempts before temporary ban
  max_retries: 5

  # How long to remember failed attempts
  find_time: 2m

  # How long to ban after max_retries
  ban_time: 5m

# ============================================================================
# Storage Backend (PostgreSQL)
# ============================================================================
storage:
  # Encryption key loaded from AUTHELIA_STORAGE_ENCRYPTION_KEY environment variable
  # Authelia reads this automatically from env

  # PostgreSQL configuration
  postgres:
    address: 'tcp://postgres-auth:5432'
    database: authelia
    username: authelia_user
    # Password loaded from AUTHELIA_STORAGE_POSTGRES_PASSWORD environment variable
    timeout: 5s

# ============================================================================
# Notification Provider (Email)
# ============================================================================
# Used for password resets and 2FA device registration
# Disabled for now - can enable later with SMTP server
notifier:
  disable_startup_check: true

  # Filesystem notifier (for testing - writes to file instead of email)
  filesystem:
    filename: /config/notification.txt

  # SMTP configuration (commented out - enable when you have email server)
  # smtp:
  #   username: noreply@mykyta-ryasny.dev
  #   password: your-email-password
  #   host: smtp.gmail.com
  #   port: 587
  #   sender: "Authelia <noreply@mykyta-ryasny.dev>"
  #   subject: "[Authelia] {title}"
  #   startup_check_address: test@mykyta-ryasny.dev
  #   disable_require_tls: false
  #   disable_html_emails: false
  #   tls:
  #     server_name: smtp.gmail.com
  #     skip_verify: false
  #     minimum_version: TLS1.2

# ============================================================================
# Identity Providers (OpenID Connect)
# ============================================================================
# Optional: Allow other apps to use Authelia as OAuth2 provider
# Commented out for now - can add later
# identity_providers:
#   oidc:
#     hmac_secret: your-oidc-hmac-secret
#     issuer_private_key: |
#       -----BEGIN RSA PRIVATE KEY-----
#       ...
#       -----END RSA PRIVATE KEY-----
#     access_token_lifespan: 1h
#     authorize_code_lifespan: 1m
#     id_token_lifespan: 1h
#     refresh_token_lifespan: 90m
#     enable_client_debug_messages: false
#     minimum_parameter_entropy: 8
#     clients:
#       - id: myapp
#         description: My Application
#         secret: your-client-secret
#         authorization_policy: two_factor
#         redirect_uris:
#           - https://myapp.mykyta-ryasny.dev/oauth2/callback
#         scopes:
#           - openid
#           - profile
#           - email
#           - groups
