---
title: Monitoring Guide
description: Grafana Loki centralized logging setup and LogQL queries
---

import { Aside, Steps } from '@astrojs/starlight/components';

Centralized logging with Grafana, Loki, and Promtail for complete observability of your home server.

## Logging Architecture

```mermaid
flowchart LR
    subgraph Containers[Docker Containers]
        C1[Jellyfin]
        C2[Radarr]
        C3[Sonarr]
        C4[Caddy]
        C5[...]
    end

    subgraph Collection[Log Collection]
        Socket[/Docker Socket/]
        Promtail[Promtail]
    end

    subgraph Storage[Storage]
        Loki[Loki]
        Index[(Index)]
        Chunks[(Chunks)]
    end

    subgraph Viz[Visualization]
        Grafana[Grafana]
        User([User])
    end

    Containers --> Socket
    Socket --> Promtail
    Promtail --> Loki
    Loki --> Index
    Loki --> Chunks
    User --> Grafana
    Grafana --> Loki

    classDef containers fill:#e3f2fd,stroke:#2196f3,color:#1565c0
    classDef collection fill:#d1fae5,stroke:#059669,color:#065f46
    classDef storage fill:#fed7aa,stroke:#ea580c,color:#9a3412
    classDef viz fill:#fce7f3,stroke:#db2777,color:#9d174d

    class C1,C2,C3,C4,C5 containers
    class Socket,Promtail collection
    class Loki,Index,Chunks storage
    class Grafana,User viz
```

## Stack Overview

| Component | Purpose | Port |
|-----------|---------|------|
| **Loki** | Log aggregation and storage | 3100 |
| **Promtail** | Collects logs from Docker containers | 9080 |
| **Grafana** | Visualization and querying | 3000 |

## Access

- **Grafana**: `https://monitor.mykyta-ryasny.dev`

<Aside type="tip" title="Authentication">
Grafana is protected by Authelia SSO. Login with your LDAP credentials.
</Aside>

## Log Flow

```mermaid
flowchart LR
    Container[Container] -->|stdout/stderr| Docker[Docker]
    Docker -->|log file| Promtail[Promtail]
    Promtail -->|push logs| Loki[Loki]
    Loki -->|query| Grafana[Grafana]
    Grafana -->|display| User([User])

    classDef container fill:#e3f2fd,stroke:#2196f3,color:#1565c0
    classDef docker fill:#0db7ed,stroke:#0db7ed,color:#fff
    classDef promtail fill:#d1fae5,stroke:#059669,color:#065f46
    classDef loki fill:#fed7aa,stroke:#ea580c,color:#9a3412
    classDef grafana fill:#fce7f3,stroke:#db2777,color:#9d174d

    class Container container
    class Docker docker
    class Promtail promtail
    class Loki loki
    class Grafana,User grafana
```

## LogQL Queries

### Basic Queries

```logql
# View all logs from a container
{container="jellyfin"}

# Filter by service group
{service_group="media"}

# Find errors across all containers
{container!=""} |= "error"

# Case-insensitive search
{container="caddy"} |~ "(?i)error"
```

### Advanced Queries

```logql
# Count errors per minute
count_over_time({level="error"}[1m])

# Top 5 noisiest containers
topk(5, sum by (container) (count_over_time({container!=""}[1h])))

# Parse JSON logs and filter
{container="caddy"} | json | status >= 400

# Rate of log lines per container
sum by (container) (rate({container!=""}[5m]))
```

### Service-Specific Queries

```logql
# Jellyfin playback issues
{container="jellyfin"} |= "playback" |= "error"

# Radarr import events
{container="radarr"} |= "imported"

# Caddy 5xx errors
{container="caddy"} | json | status >= 500

# qBittorrent download completions
{container="qbittorrent"} |= "Download finished"
```

## Labels

Promtail automatically extracts labels from Docker metadata:

```mermaid
flowchart LR
    subgraph Docker[Docker Metadata]
        D1[container_name]
        D2[compose_service]
        D3[compose_project]
        D4[container_labels]
    end

    subgraph Loki[Loki Labels]
        L1[container]
        L2[compose_service]
        L3[compose_project]
        L4[service_group]
    end

    D1 --> L1
    D2 --> L2
    D3 --> L3
    D4 --> L4

    classDef docker fill:#e3f2fd,stroke:#0db7ed,color:#1565c0
    classDef loki fill:#fed7aa,stroke:#ea580c,color:#9a3412

    class D1,D2,D3,D4 docker
    class L1,L2,L3,L4 loki
```

| Label | Description | Example |
|-------|-------------|---------|
| `container` | Container name | `jellyfin` |
| `compose_service` | Docker Compose service name | `jellyfin` |
| `compose_project` | Docker Compose project | `homeserver` |
| `service_group` | Custom label (media, auth, etc.) | `media` |

## Configuration

### Loki (`loki-config.yml`)

```yaml
schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

limits_config:
  retention_period: 720h  # 30 days
```

### Promtail (`promtail-config.yml`)

```yaml
scrape_configs:
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container
```

## Troubleshooting

### No logs appearing

<Steps>
1. Check Promtail is running and connected:
   ```bash
   docker logs promtail --tail 20
   ```

2. Verify Loki is healthy:
   ```bash
   curl http://localhost:3100/ready
   ```

3. Check the Docker socket is accessible:
   ```bash
   docker exec promtail ls -la /var/run/docker.sock
   ```
</Steps>

### Query returns nothing

- Ensure label exists: `{container="name"}`
- Check time range in Grafana (top right)
- Verify container is running and producing logs
- Try a broader query first: `{container!=""}`

### High memory usage

<Aside type="caution">
Loki can consume significant memory with broad queries. Always use labels to filter.
</Aside>

```logql
# Bad - scans all logs
{job="docker"} |= "error"

# Good - filters by container first
{container="jellyfin"} |= "error"
```
