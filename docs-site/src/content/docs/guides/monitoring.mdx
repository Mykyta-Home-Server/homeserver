---
title: Monitoring Guide
description: Grafana Loki centralized logging setup and LogQL queries
---

import { Aside, Steps } from '@astrojs/starlight/components';

Centralized logging with Grafana, Loki, and Promtail for complete observability of your home server.

## Logging Architecture

```mermaid
flowchart TB
    subgraph containers["`**Containers**`"]
        direction LR
        C1@{ shape: rect, label: "Jellyfin" }
        C2@{ shape: rect, label: "Radarr" }
        C3@{ shape: rect, label: "Sonarr" }
        C4@{ shape: rect, label: "..." }
    end

    subgraph collection["`**Collection**`"]
        direction LR
        Socket@{ shape: hex, label: "Docker Socket" }
        Promtail@{ shape: rect, label: "Promtail" }
    end

    subgraph storage["`**Storage**`"]
        direction LR
        Loki@{ shape: rect, label: "Loki" }
        Data@{ shape: cyl, label: "Database" }
    end

    subgraph viz["`**Visualization**`"]
        direction LR
        User@{ shape: circle, label: "User" }
        Grafana@{ shape: rect, label: "Grafana" }
    end

    containers --> Socket
    Socket --> Promtail
    Promtail --> Loki
    Loki --- Data
    User --> Grafana
    Grafana --> Loki

    classDef containerStyle fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    classDef collectionStyle fill:#a7f3d0,stroke:#10b981,stroke-width:2px
    classDef storageStyle fill:#fed7aa,stroke:#f97316,stroke-width:2px
    classDef vizStyle fill:#fce7f3,stroke:#ec4899,stroke-width:2px

    class C1,C2,C3,C4 containerStyle
    class Socket,Promtail collectionStyle
    class Loki,Data storageStyle
    class Grafana,User vizStyle
```

## Stack Overview

| Component | Purpose | Port |
|-----------|---------|------|
| **Loki** | Log aggregation and storage | 3100 |
| **Promtail** | Collects logs from Docker containers | 9080 |
| **Grafana** | Visualization and querying | 3000 |

## Access

- **Grafana**: `https://monitor.mykyta-ryasny.dev`

<Aside type="tip" title="Authentication">
Grafana is protected by Authelia SSO. Login with your LDAP credentials.
</Aside>

## Log Flow

```mermaid
flowchart LR
    Container@{ shape: rect, label: "Container" }
    Docker@{ shape: hex, label: "Docker Engine" }
    Promtail@{ shape: rect, label: "Promtail" }
    Loki@{ shape: cyl, label: "Loki" }
    Grafana@{ shape: rect, label: "Grafana" }
    User@{ shape: circle, label: "User" }

    Container --> Docker
    Docker --> Promtail
    Promtail --> Loki
    Grafana --> Loki
    Grafana --> User

    classDef container fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    classDef docker fill:#bae6fd,stroke:#0ea5e9,stroke-width:2px
    classDef promtail fill:#a7f3d0,stroke:#10b981,stroke-width:2px
    classDef loki fill:#fed7aa,stroke:#f97316,stroke-width:2px
    classDef grafana fill:#fce7f3,stroke:#ec4899,stroke-width:2px

    class Container container
    class Docker docker
    class Promtail promtail
    class Loki loki
    class Grafana,User grafana
```

## LogQL Queries

### Basic Queries

```logql
# View all logs from a container
{container="jellyfin"}

# Filter by service group
{service_group="media"}

# Find errors across all containers
{container!=""} |= "error"

# Case-insensitive search
{container="caddy"} |~ "(?i)error"
```

### Advanced Queries

```logql
# Count errors per minute
count_over_time({level="error"}[1m])

# Top 5 noisiest containers
topk(5, sum by (container) (count_over_time({container!=""}[1h])))

# Parse JSON logs and filter
{container="caddy"} | json | status >= 400

# Rate of log lines per container
sum by (container) (rate({container!=""}[5m]))
```

### Service-Specific Queries

```logql
# Jellyfin playback issues
{container="jellyfin"} |= "playback" |= "error"

# Radarr import events
{container="radarr"} |= "imported"

# Caddy 5xx errors
{container="caddy"} | json | status >= 500

# qBittorrent download completions
{container="qbittorrent"} |= "Download finished"
```

## Labels

Promtail automatically extracts labels from Docker metadata:

```mermaid
flowchart TB
    subgraph docker["`**Docker Metadata**`"]
        direction TB
        row1_d[" "]
        row2_d[" "]

        D1@{ shape: stadium, label: "container_name" }
        D2@{ shape: stadium, label: "service" }
        D3@{ shape: stadium, label: "project" }
        D4@{ shape: stadium, label: "labels" }

        row1_d ~~~ row2_d
        D1 ~~~ D2
        D3 ~~~ D4
    end

    subgraph loki["`**Loki Labels**`"]
        direction TB
        row1_l[" "]
        row2_l[" "]

        L1@{ shape: stadium, label: "container" }
        L2@{ shape: stadium, label: "service" }
        L3@{ shape: stadium, label: "project" }
        L4@{ shape: stadium, label: "group" }

        row1_l ~~~ row2_l
        L1 ~~~ L2
        L3 ~~~ L4
    end

    D1 --> L1
    D2 --> L2
    D3 --> L3
    D4 --> L4

    style row1_d fill:none,stroke:none
    style row2_d fill:none,stroke:none
    style row1_l fill:none,stroke:none
    style row2_l fill:none,stroke:none

    classDef dockerStyle fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
    classDef lokiStyle fill:#fed7aa,stroke:#f97316,stroke-width:2px

    class D1,D2,D3,D4 dockerStyle
    class L1,L2,L3,L4 lokiStyle
```

| Label | Description | Example |
|-------|-------------|---------|
| `container` | Container name | `jellyfin` |
| `compose_service` | Docker Compose service name | `jellyfin` |
| `compose_project` | Docker Compose project | `homeserver` |
| `service_group` | Custom label (media, auth, etc.) | `media` |

## Configuration

### Loki (`loki-config.yml`)

```yaml
schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

limits_config:
  retention_period: 720h  # 30 days
```

### Promtail (`promtail-config.yml`)

```yaml
scrape_configs:
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container
```

## Troubleshooting

### No logs appearing

<Steps>
1. Check Promtail is running and connected:
   ```bash
   docker logs promtail --tail 20
   ```

2. Verify Loki is healthy:
   ```bash
   curl http://localhost:3100/ready
   ```

3. Check the Docker socket is accessible:
   ```bash
   docker exec promtail ls -la /var/run/docker.sock
   ```
</Steps>

### Query returns nothing

- Ensure label exists: `{container="name"}`
- Check time range in Grafana (top right)
- Verify container is running and producing logs
- Try a broader query first: `{container!=""}`

### High memory usage

<Aside type="caution">
Loki can consume significant memory with broad queries. Always use labels to filter.
</Aside>

```logql
# Bad - scans all logs
{job="docker"} |= "error"

# Good - filters by container first
{container="jellyfin"} |= "error"
```
