---
title: Monitoring Guide
description: Grafana Loki centralized logging setup and LogQL queries
---

import { Aside, Steps } from '@astrojs/starlight/components';

Centralized logging with Grafana, Loki, and Promtail for complete observability of your home server.

## Logging Architecture

```mermaid
block-beta
    columns 4

    block:containers:1
        columns 1
        c1["Jellyfin"]
        c2["Radarr"]
        c3["Sonarr"]
        c4["Caddy"]
        c5["..."]
    end

    block:collection:1
        columns 1
        sock[/"Docker Socket"/]
        prom["Promtail"]
    end

    block:storage:1
        columns 1
        loki["Loki"]
        tsdb[("Index")]
        fs[("Chunks")]
    end

    block:viz:1
        columns 1
        graf["Grafana"]
        user(["User"])
    end

    containers --> sock
    sock --> prom
    prom --> loki
    loki --> tsdb
    loki --> fs
    user --> graf
    graf --> loki

    style containers fill:#e3f2fd,stroke:#2196f3
    style collection fill:#d1fae5,stroke:#059669
    style storage fill:#fed7aa,stroke:#ea580c
    style viz fill:#fce7f3,stroke:#db2777
```

## Stack Overview

| Component | Purpose | Port |
|-----------|---------|------|
| **Loki** | Log aggregation and storage | 3100 |
| **Promtail** | Collects logs from Docker containers | 9080 |
| **Grafana** | Visualization and querying | 3000 |

## Access

- **Grafana**: `https://monitor.mykyta-ryasny.dev`

<Aside type="tip" title="Authentication">
Grafana is protected by Authelia SSO. Login with your LDAP credentials.
</Aside>

## Log Flow

```mermaid
block-beta
    columns 5

    cont["Container"]:1
    dock["Docker"]:1
    prom["Promtail"]:1
    loki["Loki"]:1
    block:output:1
        columns 1
        graf["Grafana"]
        user(["User"])
    end

    space:5

    block:steps:5
        columns 1
        s1["1. Container writes to stdout/stderr"]
        s2["2. Docker writes to log file"]
        s3["3. Promtail reads via socket + extracts labels"]
        s4["4. Promtail pushes log stream to Loki"]
        s5["5. User queries via Grafana LogQL"]
    end

    cont --> dock --> prom --> loki --> graf --> user

    style cont fill:#e3f2fd,stroke:#2196f3
    style dock fill:#0db7ed,stroke:#0db7ed
    style prom fill:#d1fae5,stroke:#059669
    style loki fill:#fed7aa,stroke:#ea580c
    style output fill:#fce7f3,stroke:#db2777
    style steps fill:#f3f4f6,stroke:#6b7280
```

## LogQL Queries

### Basic Queries

```logql
# View all logs from a container
{container="jellyfin"}

# Filter by service group
{service_group="media"}

# Find errors across all containers
{container!=""} |= "error"

# Case-insensitive search
{container="caddy"} |~ "(?i)error"
```

### Advanced Queries

```logql
# Count errors per minute
count_over_time({level="error"}[1m])

# Top 5 noisiest containers
topk(5, sum by (container) (count_over_time({container!=""}[1h])))

# Parse JSON logs and filter
{container="caddy"} | json | status >= 400

# Rate of log lines per container
sum by (container) (rate({container!=""}[5m]))
```

### Service-Specific Queries

```logql
# Jellyfin playback issues
{container="jellyfin"} |= "playback" |= "error"

# Radarr import events
{container="radarr"} |= "imported"

# Caddy 5xx errors
{container="caddy"} | json | status >= 500

# qBittorrent download completions
{container="qbittorrent"} |= "Download finished"
```

## Labels

Promtail automatically extracts labels from Docker metadata:

```mermaid
block-beta
    columns 2

    block:docker:1
        columns 1
        d1["container_name"]
        d2["compose_service"]
        d3["compose_project"]
        d4["container_labels"]
    end

    block:loki:1
        columns 1
        l1["container"]
        l2["compose_service"]
        l3["compose_project"]
        l4["service_group"]
    end

    d1 --> l1
    d2 --> l2
    d3 --> l3
    d4 --> l4

    style docker fill:#e3f2fd,stroke:#0db7ed
    style loki fill:#fed7aa,stroke:#ea580c
```

| Label | Description | Example |
|-------|-------------|---------|
| `container` | Container name | `jellyfin` |
| `compose_service` | Docker Compose service name | `jellyfin` |
| `compose_project` | Docker Compose project | `homeserver` |
| `service_group` | Custom label (media, auth, etc.) | `media` |

## Configuration

### Loki (`loki-config.yml`)

```yaml
schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: filesystem
      schema: v13
      index:
        prefix: index_
        period: 24h

limits_config:
  retention_period: 720h  # 30 days
```

### Promtail (`promtail-config.yml`)

```yaml
scrape_configs:
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container
```

## Troubleshooting

### No logs appearing

<Steps>
1. Check Promtail is running and connected:
   ```bash
   docker logs promtail --tail 20
   ```

2. Verify Loki is healthy:
   ```bash
   curl http://localhost:3100/ready
   ```

3. Check the Docker socket is accessible:
   ```bash
   docker exec promtail ls -la /var/run/docker.sock
   ```
</Steps>

### Query returns nothing

- Ensure label exists: `{container="name"}`
- Check time range in Grafana (top right)
- Verify container is running and producing logs
- Try a broader query first: `{container!=""}`

### High memory usage

<Aside type="caution">
Loki can consume significant memory with broad queries. Always use labels to filter.
</Aside>

```logql
# Bad - scans all logs
{job="docker"} |= "error"

# Good - filters by container first
{container="jellyfin"} |= "error"
```
